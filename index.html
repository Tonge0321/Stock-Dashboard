var ss = SpreadsheetApp.getActiveSpreadsheet();
var sheet = ss.getSheetByName("Sheet1");

function doGet(e) {
  var action = e.parameter.action;
  if (action == "read") return readData();
  return ContentService.createTextOutput("Invalid Action");
}

function doPost(e) {
  var action = e.parameter.action;
  var data = JSON.parse(e.postData.contents);
  
  if (action == "updateNote") return updateNote(data);
  if (action == "updateShares") return updateShares(data);
  if (action == "addStock") return addStock(data);
  if (action == "deleteStock") return deleteStock(data);
  if (action == "reorderStocks") return reorderStocks(data);
  
  return ContentService.createTextOutput("Invalid Action");
}

function readData() {
  var rows = sheet.getDataRange().getValues();
  var data = [];
  
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] != "") {
      var symbol = rows[i][0];
      // 呼叫 Yahoo 抓取真實走勢
      var yahooData = fetchYahooData(symbol);
      
      data.push({
        symbol: symbol,
        note: rows[i][1],
        name: rows[i][2],
        shares: rows[i][7] === "" ? "" : rows[i][7], // 股數
        // 使用 Yahoo 的即時數據優先，如果失敗才用 Google Sheet 的數據
        price: yahooData.price || rows[i][3],
        prev: yahooData.prev || rows[i][4],
        high: yahooData.high || rows[i][5],
        low: yahooData.low || rows[i][6],
        change: yahooData.change,
        pct: yahooData.pct,
        chartData: yahooData.chartData,   // ★ 真實走勢數據
        chartLabels: yahooData.chartLabels, // ★ 真實時間軸
        isError: yahooData.isError
      });
    }
  }
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

// ★★★ 核心：抓取 Yahoo Finance 真實數據 ★★★
function fetchYahooData(googleSymbol) {
  // 1. 代碼轉換 (Google -> Yahoo)
  // TPE:2330 -> 2330.TW, NVDA -> NVDA
  var yahooSymbol = googleSymbol;
  if (googleSymbol.startsWith("TPE:")) {
    yahooSymbol = googleSymbol.replace("TPE:", "") + ".TW";
  }

  // 2. 設定 Yahoo API URL (抓取 1天範圍，5分鐘間隔)
  var url = "https://query1.finance.yahoo.com/v8/finance/chart/" + yahooSymbol + "?range=1d&interval=5m";
  
  try {
    var response = UrlFetchApp.fetch(url, {muteHttpExceptions: true});
    var json = JSON.parse(response.getContentText());
    
    if (!json.chart || !json.chart.result || json.chart.result.length === 0) {
      return { isError: true };
    }

    var result = json.chart.result[0];
    var meta = result.meta;
    var quote = result.indicators.quote[0];
    var timestamp = result.timestamp;

    // 取得價格
    var currentPrice = meta.regularMarketPrice;
    var prevClose = meta.chartPreviousClose;
    var change = currentPrice - prevClose;
    var pct = (change / prevClose) * 100;

    // 整理圖表數據 (過濾掉空值)
    var chartData = [];
    var chartLabels = [];
    
    if (timestamp && quote.close) {
      for (var i = 0; i < timestamp.length; i++) {
        // Yahoo 有時會有 null 值，需過濾
        if (quote.close[i] != null) {
          chartData.push(Number(quote.close[i].toFixed(2)));
          
          // 轉換時間戳記為 HH:mm
          var date = new Date(timestamp[i] * 1000);
          // 調整時區 (Yahoo 時間通常是 UTC，這裡簡單取本地時間格式)
          // 注意：Apps Script 的時區設定很重要，通常預設是美東或 UTC
          // 這裡我們只取時分，前端顯示時會比較簡單
          var hours = date.getHours().toString().padStart(2, '0');
          var minutes = date.getMinutes().toString().padStart(2, '0');
          chartLabels.push(hours + ":" + minutes);
        }
      }
    }

    return {
      price: currentPrice,
      prev: prevClose,
      high: meta.regularMarketDayHigh,
      low: meta.regularMarketDayLow,
      change: change,
      pct: pct,
      chartData: chartData,
      chartLabels: chartLabels,
      isError: false
    };

  } catch (e) {
    return { isError: true }; // 抓取失敗回傳錯誤標記
  }
}

// 其他基本功能保持不變
function updateNote(data) {
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.symbol) {
      sheet.getRange(i + 1, 2).setValue(data.note);
      return ContentService.createTextOutput("Success");
    }
  }
  return ContentService.createTextOutput("Error");
}

function updateShares(data) {
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.symbol) {
      sheet.getRange(i + 1, 8).setValue(data.shares);
      return ContentService.createTextOutput("Success");
    }
  }
  return ContentService.createTextOutput("Error");
}

function addStock(data) {
  var symbol = data.symbol.toString().toUpperCase().trim();
  if (/^\d{4}$/.test(symbol)) symbol = "TPE:" + symbol;
  
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == symbol) return ContentService.createTextOutput("Exists");
  }
  
  var newRow = sheet.getLastRow() + 1;
  writeRowFormula(newRow, symbol, "", ""); 
  return ContentService.createTextOutput("Success");
}

function deleteStock(data) {
  var rows = sheet.getDataRange().getValues();
  for (var i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.symbol) {
      sheet.deleteRow(i + 1);
      return ContentService.createTextOutput("Success");
    }
  }
  return ContentService.createTextOutput("Error");
}

function reorderStocks(data) {
  var newSymbols = data.symbols;
  var rows = sheet.getDataRange().getValues();
  var noteMap = {};
  var shareMap = {}; 

  for(var i=1; i<rows.length; i++) {
     noteMap[rows[i][0]] = rows[i][1];
     shareMap[rows[i][0]] = rows[i][7]; 
  }

  var lastRow = sheet.getLastRow();
  if(lastRow > 1) {
    sheet.getRange(2, 1, lastRow-1, 8).clearContent();
  }

  for(var j=0; j<newSymbols.length; j++) {
    var sym = newSymbols[j];
    var note = noteMap[sym] || "";
    var share = shareMap[sym] || "";
    writeRowFormula(j + 2, sym, note, share);
  }
  return ContentService.createTextOutput("Success");
}

function writeRowFormula(rowIdx, symbol, note, share) {
  sheet.getRange(rowIdx, 1).setValue(symbol);
  sheet.getRange(rowIdx, 2).setValue(note);
  sheet.getRange(rowIdx, 3).setFormula('=IFERROR(GOOGLEFINANCE(A' + rowIdx + ', "name"), "N/A")');
  sheet.getRange(rowIdx, 4).setFormula('=IFERROR(GOOGLEFINANCE(A' + rowIdx + ', "price"), 0)');
  sheet.getRange(rowIdx, 5).setFormula('=IFERROR(GOOGLEFINANCE(A' + rowIdx + ', "closeyest"), 0)');
  sheet.getRange(rowIdx, 6).setFormula('=IFERROR(GOOGLEFINANCE(A' + rowIdx + ', "high"), 0)');
  sheet.getRange(rowIdx, 7).setFormula('=IFERROR(GOOGLEFINANCE(A' + rowIdx + ', "low"), 0)');
  sheet.getRange(rowIdx, 8).setValue(share); 
}
