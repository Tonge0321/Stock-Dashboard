<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stocks Dashboard (With MA50)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root { --bg-color: #0d0d0d; --card-bg: #161616; --text-main: #ffffff; --text-sub: #888888; --up-color: #00e676; --down-color: #ff1744; --border-radius: 8px; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; color: white; font-size: 20px; backdrop-filter: blur(5px); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .title-group { display: flex; align-items: baseline; gap: 15px; }
        h1 { margin: 0; font-size: 24px; font-weight: 500; }
        .status-text { color: #444; font-size: 14px; }
        .btn-group { display: flex; gap: 10px; }
        button { background-color: #333; color: white; border: 1px solid #444; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        button.primary { background-color: #2979ff; border-color: #2979ff; }
        button:hover { opacity: 0.9; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        
        .sortable-ghost { opacity: 0.4; background-color: #333 !important; border: 1px dashed #666; }
        .sortable-drag { cursor: grabbing; }

        .stock-card { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 15px; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid #222; display: flex; flex-direction: column; }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 5px; cursor: grab; }
        .card-header:active { cursor: grabbing; }

        .symbol-info { display: flex; flex-direction: column; pointer-events: none; }
        .symbol { font-size: 18px; font-weight: bold; color: #fff; }
        .name { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
        
        .header-right { display: flex; flex-direction: column; align-items: flex-end; }
        .prev-close { font-size: 12px; color: var(--text-sub); margin-bottom: 4px; pointer-events: none; }
        
        .shares-wrapper { font-size: 11px; color: #666; display: flex; align-items: center; gap: 4px; }
        .shares-input { 
            width: 50px; background: #222; border: 1px solid #333; color: #ddd; font-size: 11px; padding: 1px 4px; border-radius: 3px; text-align: right; 
        }
        .shares-input:focus { border-color: #555; outline: none; background: #000; }
        
        .close-btn { position: absolute; top: -10px; right: -10px; color: #444; cursor: pointer; font-size: 16px; padding: 5px; z-index: 10; }
        .close-btn:hover { color: #ff1744; }
        
        .price-section { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 5px; margin-top: 5px; }
        .current-price { font-size: 36px; font-weight: bold; line-height: 1; }
        .price-change { text-align: right; font-size: 16px; font-weight: bold; }
        .pct { font-size: 14px; }
        
        .meta-data { display: flex; justify-content: space-between; font-size: 11px; color: var(--text-sub); font-family: 'Consolas', monospace; margin-bottom: 5px; }
        .fut-label { background: #333; color: #fff; padding: 1px 3px; border-radius: 2px; font-size: 10px; margin-right: 4px; }
        /* 新增 MA50 標籤樣式 */
        .ma50-label { background: #333; color: #FFD700; padding: 1px 3px; border-radius: 2px; font-size: 10px; margin-right: 4px; border: 1px solid #554400; }
        
        .chart-container { position: relative; height: 120px; width: 100%; margin-bottom: 10px; }
        
        .note-section { border-top: 1px solid #2a2a2a; padding-top: 8px; margin-top: auto; }
        
        .note-input {
            width: 100%; background: transparent; border: none; color: #ccc; font-size: 12px; font-family: 'Segoe UI', sans-serif; outline: none; padding: 4px 0; transition: 0.3s;
            resize: none; height: 62px; line-height: 1.5; overflow-y: auto; word-wrap: break-word;
        }
        .note-input::placeholder { color: #444; font-style: italic; }
        .note-input:focus { color: #fff; background: #222; padding-left: 5px; border-radius: 4px; }
        .note-input::-webkit-scrollbar { width: 4px; }
        .note-input::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }
        
        .text-up { color: var(--up-color); }
        .text-down { color: var(--down-color); }
    </style>
</head>
<body>

    <div id="loading">Connecting...</div>

    <div class="header">
        <div class="title-group">
            <h1>Stocks Tracking</h1>
            <span class="status-text" id="statusText">(Initializing...)</span>
        </div>
        <div class="btn-group">
            <button onclick="fetchStockData()">&#8635; Refresh</button>
            <button class="primary" onclick="addNewStock()">+ Add Stock</button>
        </div>
    </div>

    <div class="dashboard-grid" id="stockGrid"></div>

    <script>
        // ★★★ 請填入您的 API URL ★★★
        const API_URL = "https://script.google.com/macros/s/AKfycbxVeKfGwbX_5csv5lOlvUvngOHp-ied90amf2ut1M6yVxIwBI1aI94EnD6cxxMxpdBCag/exec";

        const grid = document.getElementById('stockGrid');
        const loading = document.getElementById('loading');
        const statusText = document.getElementById('statusText');

        function generateMockLabels() {
            const labels = [];
            let hour = 9, minute = 30;
            const endHour = 16;
            while (hour < endHour || (hour === endHour && minute === 0)) {
                const hStr = hour.toString().padStart(2, '0');
                const mStr = minute.toString().padStart(2, '0');
                labels.push(`${hStr}:${mStr}`);
                minute += 5; 
                if (minute >= 60) { hour++; minute = 0; }
            }
            return labels;
        }
        const MOCK_LABELS = generateMockLabels();

        window.onload = function() { 
            fetchStockData(); 
            initSortable();
            setInterval(fetchStockData, 60000); 
        };

        function initSortable() {
            new Sortable(grid, {
                animation: 150, handle: '.card-header', ghostClass: 'sortable-ghost',
                delay: 100, delayOnTouchOnly: true,
                onEnd: function (evt) { saveNewOrder(); }
            });
        }

        async function saveNewOrder() {
            statusText.innerText = "(Saving Order...)";
            const cards = document.querySelectorAll('.stock-card');
            const newOrder = Array.from(cards).map(card => card.getAttribute('data-symbol'));
            try {
                await fetch(API_URL + "?action=reorderStocks", {
                    method: 'POST', body: JSON.stringify({ symbols: newOrder, action: "reorderStocks" })
                });
                statusText.innerText = "(Order Saved)";
                setTimeout(() => { statusText.innerText = "(Synced)"; }, 2000);
            } catch (e) { console.error(e); statusText.innerText = "(Save Failed)"; }
        }

        async function fetchStockData() {
            if(grid.childElementCount === 0) loading.style.display = 'flex';
            else statusText.innerText = "(Updating...)";
            
            try {
                const response = await fetch(API_URL + "?action=read");
                const cloudData = await response.json();
                
                grid.innerHTML = '';
                if(cloudData.length === 0) {
                    grid.innerHTML = '<div style="color:#666; padding:20px;">No stocks found.</div>';
                }

                // 並行處理：抓取走勢圖 + 抓取 MA50
                const renderPromises = cloudData.map(async (item) => {
                    // 1. 抓取走勢圖
                    const chartDataPromise = fetchYahooChartFrontend(item.symbol);
                    // 2. 抓取 MA50 數據
                    const ma50Promise = fetchMA50Frontend(item.symbol);

                    // 等待兩個請求都完成
                    const [chartData, ma50Val] = await Promise.all([chartDataPromise, ma50Promise]);
                    
                    // 處理圖表數據
                    if (chartData.success) {
                        item.price = chartData.price;
                        item.prev = chartData.prev;
                        item.change = item.price - item.prev;
                        item.pct = (item.change / item.prev) * 100;
                        item.chartData = chartData.data;
                        item.chartLabels = chartData.labels;
                        item.isSimulated = false;
                    } else {
                        item = addMockChartData(item);
                    }

                    // 處理 MA50
                    item.ma50 = ma50Val;

                    return item;
                });

                const finalStocks = await Promise.all(renderPromises);

                finalStocks.forEach((item, index) => {
                    renderCard(item, index);
                });

                statusText.innerText = "(Synced: " + new Date().toLocaleTimeString() + ")";

            } catch (error) {
                console.error("Fetch Error:", error);
                statusText.innerText = "(Connection Failed)";
            } finally {
                loading.style.display = 'none';
            }
        }

        // 抓取真實走勢
        async function fetchYahooChartFrontend(symbol) {
            let yahooSymbol = symbol.replace("TPE:", "") + (symbol.includes("TPE:") ? ".TW" : "");
            const url = `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?range=1d&interval=5m`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                if (!json.chart || !json.chart.result || json.chart.result.length === 0) return { success: false };

                const result = json.chart.result[0];
                const meta = result.meta;
                const timestamp = result.timestamp;
                const quote = result.indicators.quote[0];

                if (!timestamp || !quote.close) return { success: false };

                const data = [];
                const labels = [];
                for (let i = 0; i < timestamp.length; i++) {
                    if (quote.close[i] != null) {
                        data.push(Number(quote.close[i].toFixed(2)));
                        const date = new Date(timestamp[i] * 1000);
                        const nyTime = date.toLocaleTimeString('en-US', { timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit', hour12: false });
                        labels.push(nyTime);
                    }
                }
                return { 
                    success: true, data: data, labels: labels,
                    price: meta.regularMarketPrice, prev: meta.chartPreviousClose
                };
            } catch (e) { return { success: false }; }
        }

        // ★★★ 新增：抓取 MA50 歷史數據 ★★★
        async function fetchMA50Frontend(symbol) {
            let yahooSymbol = symbol.replace("TPE:", "") + (symbol.includes("TPE:") ? ".TW" : "");
            // 抓取 3個月的日線資料
            const url = `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${yahooSymbol}?range=3mo&interval=1d`;

            try {
                const res = await fetch(url);
                const json = await res.json();
                
                if (!json.chart || !json.chart.result) return null;
                const quotes = json.chart.result[0].indicators.quote[0].close;
                
                if (!quotes || quotes.length < 50) return null; // 資料不足 50 天

                // 取最後 50 天的收盤價計算平均
                let sum = 0;
                let count = 0;
                // 從後面往前數 50 個有效數值
                for (let i = quotes.length - 1; i >= 0; i--) {
                    if (quotes[i] != null) {
                        sum += quotes[i];
                        count++;
                        if (count === 50) break;
                    }
                }

                if (count < 50) return null;
                return (sum / 50).toFixed(2);

            } catch (e) {
                console.warn("MA50 Fetch Failed", symbol);
                return null;
            }
        }

        function addMockChartData(stock) {
            let price = parseFloat(stock.price);
            let prev = parseFloat(stock.prev);
            
            if (isNaN(price) || price === 0) price = prev || 100; 
            if (isNaN(prev) || prev === 0) prev = price;

            let mockData = [];
            let tempPrice = prev; 
            for(let i=0; i < MOCK_LABELS.length - 1; i++) {
                tempPrice = tempPrice * (1 + (Math.random() - 0.5) * 0.005); 
                mockData.push(tempPrice);
            }
            mockData.push(price);

            return {
                ...stock,
                chartData: mockData, chartLabels: MOCK_LABELS, isSimulated: true
            };
        }

        async function saveNote(symbol, newNote) {
            try { await fetch(API_URL + "?action=updateNote", { method: 'POST', body: JSON.stringify({ symbol: symbol, note: newNote, action: "updateNote" }) }); } catch (e) {}
        }

        async function saveShares(symbol, newShares) {
            try { await fetch(API_URL + "?action=updateShares", { method: 'POST', body: JSON.stringify({ symbol: symbol, shares: newShares, action: "updateShares" }) }); } catch (e) {}
        }

        async function addNewStock() {
            const symbol = prompt("輸入股票代碼 (例如 2330 或 NVDA)：");
            if (symbol) {
                loading.style.display = 'flex';
                try {
                    const res = await fetch(API_URL + "?action=addStock", { method: 'POST', body: JSON.stringify({ symbol: symbol.toUpperCase().trim(), action: "addStock" }) });
                    const result = await res.text();
                    if(result === "Exists") alert("已在清單中");
                    else setTimeout(fetchStockData, 1500);
                } catch (e) { alert("新增失敗"); }
                loading.style.display = 'none';
            }
        }

        async function deleteStock(symbol) {
            if(confirm(`刪除 ${symbol} ?`)) {
                loading.style.display = 'flex';
                try { await fetch(API_URL + "?action=deleteStock", { method: 'POST', body: JSON.stringify({ symbol: symbol, action: "deleteStock" }) }); fetchStockData(); } 
                catch (e) { alert("刪除失敗"); loading.style.display = 'none'; }
            }
        }

        function renderCard(stock, index) {
            const colorClass = (stock.change >= 0) ? 'text-up' : 'text-down';
            const sign = (stock.change >= 0) ? '+' : '';
            const priceVal = Number(stock.price).toFixed(2);
            const changeVal = Number(stock.change).toFixed(2);
            const pctVal = Number(stock.pct).toFixed(2);
            const displaySymbol = stock.symbol.replace('TPE:', '');
            const sourceLabel = stock.isSimulated ? "Simulated" : "Real-time";
            const ma50Val = stock.ma50 ? `$${stock.ma50}` : "N/A";

            const cardHTML = `
                <div class="stock-card" data-symbol="${stock.symbol}">
                    <span class="close-btn" onclick="deleteStock('${stock.symbol}')">&times;</span>
                    <div class="card-header">
                        <div class="symbol-info">
                            <span class="symbol">${displaySymbol}</span>
                            <span class="name">${stock.name || 'Stock'}</span>
                        </div>
                        <div class="header-right">
                            <div class="prev-close">Prev: ${Number(stock.prev).toFixed(2)}</div>
                            <div class="shares-wrapper">
                                <input type="number" class="shares-input" placeholder="0" value="${stock.shares || ''}" onblur="saveShares('${stock.symbol}', this.value)">
                            </div>
                        </div>
                    </div>
                    
                    <div class="price-section">
                        <div class="current-price ${colorClass}">$${priceVal}</div>
                        <div class="price-change ${colorClass}">
                            <div>${sign}${changeVal}</div>
                            <div class="pct">${sign}${pctVal}%</div>
                        </div>
                    </div>

                    <div class="meta-data">
                        <div><span class="fut-label">FUT</span> ${sourceLabel} <span class="ma50-label">MA50: ${ma50Val}</span></div>
                        <div>L:${Number(stock.low).toFixed(2)} H:${Number(stock.high).toFixed(2)}</div>
                    </div>

                    <div class="chart-container">
                        <canvas id="chart-${index}"></canvas>
                    </div>

                    <div class="note-section">
                        <textarea class="note-input" placeholder="筆記..." onblur="saveNote('${stock.symbol}', this.value)">${stock.note}</textarea>
                    </div>
                </div>
            `;
            
            const div = document.createElement('div');
            div.innerHTML = cardHTML;
            grid.appendChild(div.firstElementChild);

            const ctx = document.getElementById(`chart-${index}`).getContext('2d');
            const lineColor = (stock.change >= 0) ? '#00e676' : '#ff1744';
            const gradient = ctx.createLinearGradient(0, 0, 0, 120);
            gradient.addColorStop(0, (stock.change >= 0) ? 'rgba(0, 230, 118, 0.15)' : 'rgba(255, 23, 68, 0.15)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

            const chartData = stock.chartData || [];
            const chartLabels = stock.chartLabels || [];
            const prevPrice = Number(stock.prev);
            const prevLineData = new Array(chartLabels.length).fill(prevPrice);
            
            // ★★★ 新增：MA50 線數據 (整條水平線) ★★★
            const ma50LineData = stock.ma50 ? new Array(chartLabels.length).fill(Number(stock.ma50)) : [];

            // 計算 Y 軸範圍 (包含 MA50)
            const allValues = [...chartData, prevPrice];
            if(stock.ma50) allValues.push(Number(stock.ma50));
            
            const minPrice = Math.min(...allValues) * 0.995;
            const maxPrice = Math.max(...allValues) * 1.005;

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { 
                            label: 'Price',
                            data: chartData, 
                            borderColor: lineColor, 
                            backgroundColor: gradient, 
                            borderWidth: 1.5, 
                            pointRadius: 0, 
                            fill: true, 
                            tension: 0.3 
                        }, 
                        { 
                            label: 'Prev',
                            data: prevLineData, 
                            borderColor: '#666', 
                            borderWidth: 1, 
                            borderDash: [5, 3], 
                            pointRadius: 0, 
                            fill: false 
                        },
                        // ★★★ MA50 Dataset ★★★
                        {
                            label: 'MA50',
                            data: ma50LineData,
                            borderColor: '#FFD700', // 金黃色
                            borderWidth: 1,
                            borderDash: [2, 2], // 點狀虛線
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: { display: true, grid: { color: '#222', drawBorder: false }, ticks: { display: true, color: '#555', font: { size: 10 }, maxTicksLimit: 6 } },
                        y: { display: true, position: 'right', min: minPrice, max: maxPrice, grid: { color: '#2a2a2a', borderDash: [2, 2] }, ticks: { color: '#666', font: { size: 10 }, callback: function(v){return Number(v).toFixed(1);} } }
                    },
                    interaction: { mode: 'nearest', axis: 'x', intersect: false }
                }
            });
        }
    </script>
</body>
</html>
