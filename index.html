<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stocks Dashboard Doctor (Debug Mode)</title>
    <style>
        body { background-color: #111; color: #fff; font-family: monospace; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #ffeb3b; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        .input-group { background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; }
        input[type="text"] { width: 100%; padding: 10px; background: #000; border: 1px solid #555; color: #0f0; font-family: monospace; border-radius: 4px; box-sizing: border-box; }
        button { margin-top: 10px; padding: 10px 20px; background: #2979ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #2262cc; }
        
        .log-box { background: #000; border: 1px solid #333; padding: 15px; height: 400px; overflow-y: auto; white-space: pre-wrap; font-family: 'Consolas', monospace; color: #ccc; border-radius: 4px; }
        .log-info { color: #81d4fa; }
        .log-success { color: #69f0ae; font-weight: bold; }
        .log-error { color: #ff5252; font-weight: bold; }
        .log-warn { color: #ffd740; }
        
        .step { margin-bottom: 10px; padding: 10px; border-left: 3px solid #555; background: #1a1a1a; }
        .step.active { border-left-color: #2979ff; background: #1e2a3a; }
        .step h3 { margin: 0 0 5px 0; font-size: 16px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš‘ å„€è¡¨æ¿é€£ç·šè¨ºæ–·å·¥å…·</h1>
    
    <div class="input-group">
        <label>è«‹è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€ (çµå°¾æ˜¯ /exec)ï¼š</label>
        <input type="text" id="apiUrl" placeholder="https://script.google.com/macros/s/..../exec" />
        <button onclick="startDiagnostics()">é–‹å§‹è¨ºæ–· (Start Diagnosis)</button>
    </div>

    <div id="steps">
        </div>

    <label>è¨ºæ–·æ—¥èªŒ (Logs):</label>
    <div class="log-box" id="console">ç­‰å¾…é–‹å§‹...</div>
</div>

<script>
    const logger = document.getElementById('console');
    
    function log(msg, type = 'info') {
        const span = document.createElement('div');
        span.className = `log-${type}`;
        const time = new Date().toLocaleTimeString();
        span.innerText = `[${time}] ${msg}`;
        logger.appendChild(span);
        logger.scrollTop = logger.scrollHeight;
    }

    async function startDiagnostics() {
        const url = document.getElementById('apiUrl').value.trim();
        logger.innerHTML = ''; // æ¸…ç©ºæ—¥èªŒ
        
        if (!url) {
            log("âŒ éŒ¯èª¤ï¼šè«‹å…ˆè¼¸å…¥ç¶²å€ï¼", "error");
            return;
        }
        if (!url.endsWith('/exec')) {
            log("âš ï¸ è­¦å‘Šï¼šç¶²å€çµå°¾é€šå¸¸æ˜¯ '/exec'ï¼Œè«‹ç¢ºèªæ‚¨è¤‡è£½å®Œæ•´ã€‚", "warn");
        }

        log("ğŸš€ é–‹å§‹è¨ºæ–·ç¨‹åº...", "info");

        // --- æ­¥é©Ÿ 1: æ¸¬è©¦ Google Script é€£ç·š ---
        log("------------------------------------------------", "info");
        log("ğŸ” æ­¥é©Ÿ 1: æ¸¬è©¦ Google Sheet é€£ç·š (Backend)", "info");
        try {
            const fetchUrl = url + "?action=read";
            log(`å˜—è©¦é€£ç·šè‡³: ${fetchUrl}`, "info");
            
            const start = Date.now();
            const response = await fetch(fetchUrl);
            const timeTaken = Date.now() - start;
            
            if (!response.ok) {
                throw new Error(`HTTP éŒ¯èª¤: ${response.status} ${response.statusText}`);
            }
            
            const text = await response.text();
            log(`âœ… é€£ç·šæˆåŠŸï¼(è€—æ™‚ ${timeTaken}ms)`, "success");
            
            // å˜—è©¦è§£æ JSON
            try {
                const data = JSON.parse(text);
                log(`âœ… JSON è§£ææˆåŠŸï¼æ”¶åˆ° ${data.length} ç­†è‚¡ç¥¨è³‡æ–™ã€‚`, "success");
                
                if (data.length > 0) {
                    log(`   ç¬¬ä¸€ç­†è³‡æ–™ç¯„ä¾‹: ${data[0].symbol} ($${data[0].price})`, "info");
                } else {
                    log("âš ï¸ è­¦å‘Šï¼šè³‡æ–™åº«æ˜¯ç©ºçš„ (æ²’æœ‰è‚¡ç¥¨)ã€‚", "warn");
                }
            } catch (e) {
                log("âŒ JSON è§£æå¤±æ•—ï¼šå¾Œç«¯å›å‚³çš„ä¸æ˜¯æœ‰æ•ˆè³‡æ–™ã€‚", "error");
                log("å›å‚³å…§å®¹é–‹é ­: " + text.substring(0, 100) + "...", "error");
                log("å¯èƒ½åŸå› ï¼šæ‚¨æ˜¯ä¸æ˜¯ä¸å°å¿ƒæŠŠ HTML è²¼åˆ° Apps Script è£¡äº†ï¼Ÿ", "warn");
                return; // ä¸­æ­¢
            }

        } catch (error) {
            log("âŒ æ­¥é©Ÿ 1 å¤±æ•— (è‡´å‘½éŒ¯èª¤)", "error");
            log(`éŒ¯èª¤è¨Šæ¯: ${error.message}`, "error");
            
            if (error.message.includes("Failed to fetch")) {
                log("ğŸ‘‰ å¯èƒ½åŸå› ï¼šCORS æ¬Šé™è¢«æ‹’çµ•ã€‚", "warn");
                log("1. è«‹ç¢ºèªéƒ¨ç½²æ™‚ã€Œèª°å¯ä»¥å­˜å–ã€é¸äº†ã€Œä»»ä½•äºº (Anyone)ã€ã€‚", "warn");
                log("2. è«‹ç¢ºèªæ‚¨ä½¿ç”¨çš„æ˜¯ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ç¶²å€ï¼Œä¸æ˜¯ç·¨è¼¯å™¨ç¶²å€ã€‚", "warn");
            }
            return; // ä¸­æ­¢
        }

        // --- æ­¥é©Ÿ 2: æ¸¬è©¦ Yahoo Proxy é€£ç·š ---
        log("------------------------------------------------", "info");
        log("ğŸ” æ­¥é©Ÿ 2: æ¸¬è©¦å¤–éƒ¨æ•¸æ“šé€£ç·š (Yahoo Proxy)", "info");
        
        const symbols = ["2330.TW", "NVDA"]; // æ¸¬è©¦ä¸€æª”å°è‚¡ä¸€æª”ç¾è‚¡
        
        for (let sym of symbols) {
            log(`æ­£åœ¨æ¸¬è©¦æŠ“å– ${sym}...`, "info");
            
            // æ¸¬è©¦é€šé“ A
            try {
                const urlA = `https://corsproxy.io/?https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=5m`;
                const resA = await fetch(urlA);
                if (resA.ok) {
                    const jsonA = await resA.json();
                    if (jsonA.chart && jsonA.chart.result) {
                        log(`âœ… é€šé“ A (CorsProxy) æˆåŠŸæŠ“å– ${sym}`, "success");
                    } else {
                        log(`âš ï¸ é€šé“ A å›å‚³ç©ºè³‡æ–™`, "warn");
                    }
                } else {
                    log(`âŒ é€šé“ A å¤±æ•— (HTTP ${resA.status})`, "error");
                }
            } catch (e) {
                log(`âŒ é€šé“ A é€£ç·šéŒ¯èª¤: ${e.message}`, "error");
            }

            // æ¸¬è©¦é€šé“ B
            try {
                const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=5m`;
                const urlB = `https://api.allorigins.win/raw?url=${encodeURIComponent(targetUrl)}`;
                const resB = await fetch(urlB);
                if (resB.ok) {
                    const jsonB = await resB.json();
                    if (jsonB.chart && jsonB.chart.result) {
                        log(`âœ… é€šé“ B (AllOrigins) æˆåŠŸæŠ“å– ${sym}`, "success");
                    } else {
                        log(`âš ï¸ é€šé“ B å›å‚³ç©ºè³‡æ–™`, "warn");
                    }
                } else {
                    log(`âŒ é€šé“ B å¤±æ•— (HTTP ${resB.status})`, "error");
                }
            } catch (e) {
                log(`âŒ é€šé“ B é€£ç·šéŒ¯èª¤: ${e.message}`, "error");
            }
        }

        log("------------------------------------------------", "info");
        log("ğŸ‰ è¨ºæ–·å®Œæˆï¼", "success");
        log("çµè«–ï¼š", "info");
        log("1. å¦‚æœæ­¥é©Ÿ 1 å¤±æ•— -> æ‚¨çš„ Apps Script éƒ¨ç½²æœ‰å•é¡Œï¼Œè«‹é‡æ–°æª¢æŸ¥æ¬Šé™ã€‚", "warn");
        log("2. å¦‚æœæ­¥é©Ÿ 1 æˆåŠŸä½†æ­¥é©Ÿ 2 å¤±æ•— -> æ‚¨çš„ç¶²è·¯ç’°å¢ƒæ“‹ä½äº† Proxyã€‚", "warn");
        log("3. å¦‚æœå…©è€…éƒ½æˆåŠŸ -> è«‹è¤‡è£½ä¸Šæ–¹çš„æ­£ç¢ºç¶²å€ï¼Œè²¼å›åŸæœ¬çš„ HTML ç¨‹å¼ç¢¼ä¸­ã€‚", "success");
    }
</script>

</body>
</html>
